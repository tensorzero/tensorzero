# ========== chef ==========

FROM lukemathwalker/cargo-chef:latest-rust-1.88-trixie AS chef

WORKDIR /src

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Install cargo-binstall for faster tool installation
RUN curl -L --proto '=https' --tlsv1.2 -sSf \
  https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

# Install cargo-nextest using binstall
RUN cargo binstall -y cargo-nextest --secure

# ========== planner ==========

FROM chef AS planner
WORKDIR /app
COPY . .
RUN git rev-parse HEAD
RUN cargo chef prepare --recipe-path recipe.json

# ========== builder ==========

FROM chef AS builder

WORKDIR /app

# Copy recipe and cook dependencies first (cached layer)
COPY --from=planner /app/recipe.json recipe.json
RUN cargo chef cook --features e2e_tests --recipe-path recipe.json

# Copy the entire project
COPY . .

# Fetch all dependencies (including dev-dependencies needed by trybuild)
RUN cargo fetch --locked

# Build and archive tests
RUN cargo nextest archive --features e2e_tests --profile e2e --archive-file tests.tar.zst --offline

# ========== test-env ==========

FROM debian:trixie-slim AS test-env

WORKDIR /app

# Copy only the cargo-nextest binary (not the full Rust toolchain)
COPY --from=builder /usr/local/cargo/bin/cargo-nextest /usr/local/bin/cargo-nextest

# Copy workspace structure but exclude target directory
COPY . ./
RUN rm -rf target

# Copy only the test archive
COPY --from=builder /app/tests.tar.zst /app/tests.tar.zst

# Set CI environment variable
ENV CI=true

# Run tests using cargo-nextest directly (no cargo needed for archive-based runs)
# If CARGO_NEXTEST_FLAKY_TESTS is set, exclude those tests using -E filter
CMD ["sh", "-c", "cargo-nextest nextest run --no-fail-fast --archive-file tests.tar.zst --workspace-remap /app --config-file /app/.config/nextest.toml --profile e2e -j 32 ${CARGO_NEXTEST_FLAKY_TESTS:+-E \"not ($CARGO_NEXTEST_FLAKY_TESTS)\"}"]
