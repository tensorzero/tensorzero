# ========== base ==========

FROM rust:1.90.0-slim AS base

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

 # Install cargo-binstall for faster tool installation
RUN curl -L --proto '=https' --tlsv1.2 -sSf \
  https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

# Install cargo-nextest using binstall
RUN cargo binstall -y cargo-nextest --secure

# ========== build-env ==========

FROM base AS builder

WORKDIR /app

# Copy the entire project
COPY . .

# Fetch all dependencies first (including dev-dependencies needed by trybuild)
RUN cargo fetch --locked

# Build and archive tests instead of copying entire target directory
RUN cargo nextest archive --features e2e_tests --profile e2e --archive-file tests.tar.zst --offline

# ========== test-env ==========

FROM base AS test-env

WORKDIR /app

# Copy workspace structure but exclude target directory
COPY . ./
RUN rm -rf target

# Copy only the test archive instead of entire target directory
COPY --from=builder /app/tests.tar.zst /app/tests.tar.zst

# Set CI environment variable
ENV CI=true

# Set the entrypoint to run tests from archive with absolute config file path and e2e profile
# If CARGO_NEXTEST_FLAKY_TESTS is set, exclude those tests using -E filter
CMD ["sh", "-c", "cargo nextest run --no-fail-fast --archive-file tests.tar.zst --workspace-remap /app --config-file /app/.config/nextest.toml --profile e2e -j 32 ${CARGO_NEXTEST_FLAKY_TESTS:+-E \"not ($CARGO_NEXTEST_FLAKY_TESTS)\"}"]
