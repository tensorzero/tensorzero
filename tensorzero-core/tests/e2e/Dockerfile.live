# ========== chef ==========

FROM lukemathwalker/cargo-chef:latest-rust-1.93-trixie AS chef

WORKDIR /app

# Install cargo-nextest
RUN curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C /usr/local/cargo/bin

# ========== planner ==========

FROM chef AS planner

COPY . .
RUN cargo chef prepare --recipe-path recipe.json

# ========== builder ==========

FROM chef AS builder

# Cook dependencies (cached layer)
COPY --from=planner /app/recipe.json recipe.json
RUN cargo chef cook --tests --features e2e_tests --recipe-path recipe.json

# Build tests
COPY . .
RUN cargo nextest archive --features e2e_tests --profile e2e --archive-file tests.tar.zst

# ========== test-env ==========

FROM debian:trixie-slim AS test-env

RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy nextest binary
COPY --from=builder /usr/local/cargo/bin/cargo-nextest /usr/local/bin/cargo-nextest

# Copy workspace structure
COPY . .

# Copy only the test archive instead of entire target directory
COPY --from=builder /app/tests.tar.zst /app/tests.tar.zst

# Set CI environment variable
ENV CI=true

# Set the entrypoint to run tests from archive with absolute config file path and e2e profile
# If CARGO_NEXTEST_FLAKY_TESTS is set, exclude those tests using -E filter
CMD ["sh", "-c", "cargo-nextest nextest run --no-fail-fast --archive-file tests.tar.zst --workspace-remap /app --config-file /app/.config/nextest.toml --profile e2e -j 32 ${CARGO_NEXTEST_FLAKY_TESTS:+-E \"not ($CARGO_NEXTEST_FLAKY_TESTS)\"}"]
