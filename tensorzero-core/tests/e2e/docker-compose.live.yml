include:
  - docker-compose-common.yml

volumes:
  # Note that we don't actually make this a tmpfs, since it can be quite large
  # We need this for e2e tests that write to a tmpdir from a test, and then read it from the gateway
  shared-tmpdir:

services:
  mock-inference-provider:
    image: tensorzero/mock-inference-provider:${TENSORZERO_COMMIT_TAG}
    build:
      context: ../../../
      dockerfile: tensorzero-core/tests/mock-inference-provider/Dockerfile
    environment:
      RUST_LOG: debug
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcp_jwt_key.json
    volumes:
      # Mount GCP JWT key file for GCS access (needed for batch inference)
      # Can be overridden with GCP_CREDENTIALS_PATH env var
      - ${GCP_CREDENTIALS_PATH:-../../../gcp_jwt_key.json}:/app/gcp_jwt_key.json:ro
    ports:
      - "3030:3030"

  provider-proxy:
    image: tensorzero/provider-proxy:${TENSORZERO_COMMIT_TAG}
    build:
      context: ../../..
      dockerfile: provider-proxy/Dockerfile
      target: provider-proxy
    ports:
      - "3003:3003"
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    volumes:
      # Mount cache directory for downloading cache files separately
      - ../../../ci/provider-proxy-cache:/app/ci/provider-proxy-cache
    command:
      [
        "--cache-path",
        "/app/ci/provider-proxy-cache",
        "--mode",
        "read-old-write-new",
      ]
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "--tries=1", "http://localhost:3004/health"]
      start_period: 10s
      start_interval: 1s
      timeout: 1s
    depends_on:
      minio:
        condition: service_healthy

  gateway:
    image: tensorzero/gateway-e2e:${TENSORZERO_COMMIT_TAG}
    build:
      context: ../../..
      dockerfile: gateway/Dockerfile
      target: gateway
      args:
        CARGO_BUILD_FLAGS: --features e2e_tests
        PROFILE: dev
    environment:
      # Test environment variables
      TENSORZERO_GATEWAY_URL: http://gateway:3000
      TENSORZERO_CLICKHOUSE_URL: http://chuser:chpassword@clickhouse:8123/tensorzero_e2e_tests
      TENSORZERO_MINIO_URL: http://minio:9000/
      TENSORZERO_E2E_PROXY: http://provider-proxy:3003
      TENSORZERO_MOCK_INFERENCE_PROVIDER_BASE_URL: http://mock-inference-provider:3030
      BUILDKITE_COMMIT: ${BUILDKITE_COMMIT:-}
      TMPDIR: /tmp
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      # API Keys
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AZURE_OPENAI_API_BASE: ${AZURE_OPENAI_API_BASE:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_EASTUS2_API_KEY: ${AZURE_OPENAI_EASTUS2_API_KEY:-}
      AZURE_OPENAI_DEPLOYMENT_ID: ${AZURE_OPENAI_DEPLOYMENT_ID:-}
      AZURE_AI_FOUNDRY_API_KEY: ${AZURE_AI_FOUNDRY_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      FIREWORKS_API_KEY: ${FIREWORKS_API_KEY:-}
      FIREWORKS_ACCOUNT_ID: ${FIREWORKS_ACCOUNT_ID:-}
      GCP_VERTEX_CREDENTIALS_PATH: /app/gcp_jwt_key.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcp_jwt_key.json
      GCP_STORAGE_ACCESS_KEY_ID: ${GCP_STORAGE_ACCESS_KEY_ID:-}
      GCP_STORAGE_SECRET_ACCESS_KEY: ${GCP_STORAGE_SECRET_ACCESS_KEY:-}
      GOOGLE_AI_STUDIO_API_KEY: ${GOOGLE_AI_STUDIO_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      HYPERBOLIC_API_KEY: ${HYPERBOLIC_API_KEY:-}
      MODAL_KEY: ${MODAL_KEY:-}
      MODAL_SECRET: ${MODAL_SECRET:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
      SGLANG_API_KEY: ${SGLANG_API_KEY:-}
      TGI_API_KEY: ${TGI_API_KEY:-}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY:-}
      VLLM_API_KEY: ${VLLM_API_KEY:-}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
    command: [--config-file, tensorzero-core/tests/e2e/config/tensorzero.*.toml]
    volumes:
      # Mount the e2e directory so the config path exists inside the container
      - ./:/app/tensorzero-core/tests/e2e:ro
      # Mount the fixtures directory so template paths can be resolved
      - ../../fixtures:/app/tensorzero-core/fixtures:ro
      # Mount GCP JWT key file
      - ../../../gcp_jwt_key.json:/app/gcp_jwt_key.json:ro
      # Shared tmpdir filesystem
      - shared-tmpdir:/tmp
    depends_on:
      clickhouse:
        condition: service_healthy
      gateway-clickhouse-migrations:
        condition: service_healthy
      postgres:
        condition: service_healthy
      gateway-postgres-migrations:
        condition: service_healthy
      provider-proxy:
        condition: service_healthy
      minio:
        condition: service_healthy
    extra_hosts:
      - "howdy.tensorzero.com:127.0.0.1"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      start_period: 1s
      start_interval: 1s
      timeout: 1s
  fixtures:
    image: tensorzero/fixtures:${TENSORZERO_COMMIT_TAG}
    build:
      context: ../../../
      dockerfile: ui/fixtures/Dockerfile
    volumes:
      - ../../../ui/fixtures:/fixtures
      - ~/.aws:/root/.aws
    environment:
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PASSWORD=chpassword
      - CLICKHOUSE_USER=chuser
      - TENSORZERO_SKIP_LARGE_FIXTURES=1
    depends_on:
      gateway:
        condition: service_healthy
    # Keep this running to make 'check-docker-compose.sh' detect that all containers are healthy
    command:
      ["bash", "-c", "cd /fixtures && ./load_fixtures.sh tensorzero_e2e_tests"]
    healthcheck:
      test: ["CMD", "test", "-f", "/load_complete.marker"]
      interval: 5s
      timeout: 1s
      retries: 48 # Retry for up to 4 minutes
      start_period: 5s # Give the script time to start

  live-tests:
    image: tensorzero/live-tests:${TENSORZERO_COMMIT_TAG}
    build:
      context: ../../..
      dockerfile: tensorzero-core/tests/e2e/Dockerfile.live
    environment:
      # Test environment variables
      TENSORZERO_GATEWAY_URL: http://gateway:3000
      TENSORZERO_GATEWAY_HOST: gateway
      TENSORZERO_CLICKHOUSE_URL: http://chuser:chpassword@clickhouse:8123/tensorzero_e2e_tests
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/tensorzero-e2e-tests
      TENSORZERO_POSTGRES_URL: postgres://postgres:postgres@postgres:5432/tensorzero-e2e-tests
      TENSORZERO_MINIO_URL: http://minio:9000
      TENSORZERO_MOCK_INFERENCE_PROVIDER_BASE_URL: http://mock-inference-provider:3030
      TENSORZERO_TEMPO_URL: http://tempo:3200
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      TENSORZERO_E2E_PROXY: http://provider-proxy:3003
      BUILDKITE_COMMIT: ${BUILDKITE_COMMIT:-}
      TMPDIR: /tmp
      # API Keys
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AZURE_OPENAI_API_BASE: ${AZURE_OPENAI_API_BASE:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_EASTUS2_API_KEY: ${AZURE_OPENAI_EASTUS2_API_KEY:-}
      AZURE_OPENAI_DEPLOYMENT_ID: ${AZURE_OPENAI_DEPLOYMENT_ID:-}
      AZURE_AI_FOUNDRY_API_KEY: ${AZURE_AI_FOUNDRY_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      FIREWORKS_API_KEY: ${FIREWORKS_API_KEY:-}
      FIREWORKS_ACCOUNT_ID: ${FIREWORKS_ACCOUNT_ID:-}
      FORCE_COLOR: ${FORCE_COLOR:-1}
      GCP_VERTEX_CREDENTIALS_PATH: /app/gcp_jwt_key.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcp_jwt_key.json
      GCP_STORAGE_ACCESS_KEY_ID: ${GCP_STORAGE_ACCESS_KEY_ID:-}
      GCP_STORAGE_SECRET_ACCESS_KEY: ${GCP_STORAGE_SECRET_ACCESS_KEY:-}
      GOOGLE_AI_STUDIO_API_KEY: ${GOOGLE_AI_STUDIO_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      HYPERBOLIC_API_KEY: ${HYPERBOLIC_API_KEY:-}
      MODAL_KEY: ${MODAL_KEY:-}
      MODAL_SECRET: ${MODAL_SECRET:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
      SGLANG_API_KEY: ${SGLANG_API_KEY:-}
      TGI_API_KEY: ${TGI_API_KEY:-}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY:-}
      VLLM_API_KEY: ${VLLM_API_KEY:-}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      # Buildkite analytics
      BUILDKITE_ANALYTICS_TOKEN: ${BUILDKITE_ANALYTICS_TOKEN:-}
    volumes:
      - ../../../gcp_jwt_key.json:/app/gcp_jwt_key.json:ro
      - ./config:/app/tensorzero-core/tests/e2e/config:ro
      - ../../fixtures:/app/tensorzero-core/fixtures:ro
      - .cargo/:/app/.cargo/
      - ../../../target/nextest:/app/target/nextest
      # Shared tmpdir filesystem
      - shared-tmpdir:/tmp
    depends_on:
      fixtures:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy
      gateway-postgres-migrations:
        condition: service_healthy
      mock-inference-provider:
        condition: service_healthy
      provider-proxy:
        condition: service_healthy
      minio:
        condition: service_healthy
      otel-collector:
        condition: service_started
      tempo:
        condition: service_started
