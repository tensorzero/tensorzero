steps:
  - label: "Build Gateway Container"
    command: bash ./ci/buildkite/build-gateway-container.sh
    key: "build-gateway-container"
    artifact_paths:
      - gateway-container.tar

  - label: "Build UI Container"
    command: bash ./ci/buildkite/build-ui-container.sh
    key: "build-ui-container"
    artifact_paths:
      - ui-container.tar

  - label: "Build Mock Inference Provider Container"
    command: bash ./ci/buildkite/build-mock-inference-provider-container.sh
    key: "build-mock-inference-provider-container"
    artifact_paths:
      - mock-inference-provider-container.tar

  - label: "Build Cargo workspace (e2e)"
    command: bash ./ci/buildkite/build-cargo-e2e.sh
    key: "build-cargo-e2e"
    artifact_paths:
      - target.e2e.tar.gz

  - label: "Download S3 Fixtures"
    command: bash ./ci/buildkite/download-fixtures.sh
    key: "download-fixtures"
    artifact_paths:
      - fixtures.tar.gz

  - label: ":rust: Rust Unit Tests"
    command: bash ./ci/buildkite/rust-unit-tests.sh
    plugins:
      - docker:
          image: "rust"
          mount-buildkite-agent: true

  - label: ":node: Node.js Tests"
    # command: bash ./ci/buildkite/node-unit-tests.sh
    command: bash ./ci/buildkite/node-unit-tests.sh
    depends_on: "build-gateway-container"

  - label: "UI E2E Tests (without LLM credentials)"
    command: bash ./ci/buildkite/ui-e2e-tests.sh
    depends_on:
      - "build-ui-container"
      - "build-gateway-container"
      - "build-mock-inference-provider-container"

  - label: "ClickHouse Tests"
    command: bash ./ci/buildkite/clickhouse-tests.sh | sleep infinity
    depends_on:
      - "download-fixtures"
      - "build-gateway-container"
      - "build-mock-inference-provider-container"
      - "build-cargo-e2e"
