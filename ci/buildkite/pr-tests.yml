steps:
  - label: "Build Gateway Container"
    command: bash ./ci/buildkite/build-gateway-container.sh
    key: "build-gateway-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build Gateway E2E Container"
    command: bash ./ci/buildkite/build-gateway-e2e-container.sh
    key: "build-gateway-e2e-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build Fixtures Container"
    command: bash ./ci/buildkite/build-fixtures-container.sh
    key: "build-fixtures-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build Mock Inference Provider Container"
    command: bash ./ci/buildkite/build-mock-inference-provider-container.sh
    key: "build-mock-inference-provider-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Download S3 Fixtures"
    command: bash ./ci/buildkite/download-fixtures.sh
    key: "download-fixtures"
    artifact_paths:
      - fixtures.tar.gz

  - label: "Build Node Unit Tests Container"
    command: bash ./ci/buildkite/build-node-unit-tests-container.sh
    key: "build-node-unit-tests-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build UI Container"
    command: bash ./ci/buildkite/build-ui-container.sh
    key: "build-ui-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build UI E2E Tests Container"
    command: bash ./ci/buildkite/build-ui-e2e-tests-container.sh
    key: "build-ui-e2e-tests-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: "Build ClickHouse Tests Container"
    command: bash ./ci/buildkite/build-clickhouse-tests.sh
    key: "build-clickhouse-tests-container"
    retry:
      automatic:
        - exit_status: "*"
          limit: 3

  - label: ":rust: Rust Unit Tests"
    command: bash ./ci/buildkite/rust-unit-tests.sh
    plugins:
      - docker:
          image: "rust"
          mount-buildkite-agent: true
          propagate-environment: true

  - label: ":node: Node.js Tests"
    command: bash ./ci/buildkite/node-unit-tests.sh
    depends_on:
      - "build-gateway-container"
      - "build-node-unit-tests-container"
      - "build-fixtures-container"
      - "build-mock-inference-provider-container"

  - label: ":playwright: UI E2E Tests"
    command: |
      bash ./ci/buildkite/ui-e2e-tests.sh
    depends_on:
      - "build-gateway-container"
      - "build-mock-inference-provider-container"
      - "build-ui-container"
      - "build-ui-e2e-tests-container"
      - "build-fixtures-container"
    artifact_paths:
      - "ui/fixtures/ui-e2e-artifacts.zip"

  - label: "ClickHouse Tests (version {{matrix.clickhouse_version}})"
    command: bash ./ci/buildkite/clickhouse-tests.sh
    matrix:
      setup:
        clickhouse_version:
          - "24.12"
          - "25.7"
    env:
      TENSORZERO_CLICKHOUSE_VERSION: "{{matrix.clickhouse_version}}"
    depends_on:
      - "build-gateway-e2e-container"
      - "build-clickhouse-tests-container"
      - "download-fixtures"
      - "build-fixtures-container"
