steps:
  - label: "Build Gateway Container"
    command: bash ./ci/buildkite/build-gateway-container.sh
    key: "build-gateway-container"

  - label: "Build Gateway E2E Container"
    command: bash ./ci/buildkite/build-gateway-e2e-container.sh
    key: "build-gateway-e2e-container"

  - label: "Build Mock Inference Provider Container"
    command: bash ./ci/buildkite/build-mock-inference-provider-container.sh
    key: "build-mock-inference-provider-container"

  - label: "Download S3 Fixtures"
    command: bash ./ci/buildkite/download-fixtures.sh
    key: "download-fixtures"
    artifact_paths:
      - fixtures.tar.gz

  - label: "Build Node Unit Tests Container"
    command: bash ./ci/buildkite/build-node-unit-tests-container.sh
    key: "build-node-unit-tests-container"

  - label: "Build UI Container"
    command: bash ./ci/buildkite/build-ui-container.sh
    key: "build-ui-container"

  - label: "Build UI E2E Tests Container"
    command: bash ./ci/buildkite/build-ui-e2e-tests-container.sh
    key: "build-ui-e2e-tests-container"

  - label: "Build ClickHouse Tests Container"
    command: bash ./ci/buildkite/build-clickhouse-tests.sh
    key: "build-clickhouse-tests-container"

  - label: "Build Provider Proxy Container"
    command: bash ./ci/buildkite/build-provider-proxy-container.sh
    key: "build-provider-proxy-container"

  - label: "Download Provider Proxy Cache"
    command: bash ./ci/buildkite/download-provider-proxy-cache.sh
    key: "download-provider-proxy-cache"
    artifact_paths:
      - provider-proxy-cache.tar.gz

  - label: "Modal Service Warmup"
    command: bash ./ci/buildkite/modal-warmup.sh
    key: "modal-warmup"

  - label: ":rust: Rust Unit Tests"
    command: bash ./ci/buildkite/rust-unit-tests.sh
    plugins:
      - docker:
          image: "rust"
          mount-buildkite-agent: true
          propagate-environment: true

  - label: ":node: Node.js Tests"
    command: ./ci/buildkite/node-unit-tests.sh
    depends_on:
      - "build-gateway-container"
      - "build-node-unit-tests-container"

  - label: ":playwright: UI E2E Tests (without LLM credentials)"
    command: |
      bash ./ci/buildkite/ui-e2e-tests.sh
    depends_on:
      - "build-gateway-container"
      - "build-mock-inference-provider-container"
      - "build-ui-container"
      - "build-ui-e2e-tests-container"
    artifact_paths:
      - "ui/fixtures/ui-e2e-artifacts.zip"

  - label: "ClickHouse Tests (version {{matrix.clickhouse_version}})"
    command: ./ci/buildkite/clickhouse-tests.sh
    matrix:
      setup:
        clickhouse_version:
          - "24.12-alpine"
          - "latest-alpine"
    env:
      TENSORZERO_CLICKHOUSE_VERSION: "{{matrix.clickhouse_version}}"
    depends_on:
      - "build-gateway-e2e-container"
      - "build-clickhouse-tests-container"
      - "download-fixtures"

  - label: "Live Tests"
    command: bash ./ci/buildkite/live-tests.sh
    depends_on:
      - "build-gateway-container"
      - "build-mock-inference-provider-container"
      - "build-provider-proxy-container"
      - "modal-warmup"
      - "download-provider-proxy-cache"
