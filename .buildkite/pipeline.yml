agents:
  queue: "t0-merge-queue"

# We need to use individual steps instead of a build matrix, as we can't use matrix keys
# inside concurrency_group
steps:
  - label: "Clickhouse Cloud tests - normal release channel"
    plugins:
      - peakon/git-shallow-clone#006b6c0e9e5c73a95c8ac62a60f10cb9ca3c455f:
          depth: 1
    concurrency: 1
    concurrency_group: "clickhouse-cloud-normal-${CLICKHOUSE_ID}"
    command: CLICKHOUSE_PREFIX="dev-tensorzero-e2e-tests-instance-" ./ci/buildkite/test-clickhouse-cloud.sh
    # Priority for merge queue builds - earlier queue positions get higher priority
    # MERGE_QUEUE_PRIORITY is set in post-checkout hook as the negative of queue position
    # See https://buildkite.com/docs/pipelines/configure/workflows/controlling-concurrency#concurrency-and-parallelism-concurrency-and-prioritization
    priority: ${MERGE_QUEUE_PRIORITY:-0}
    concurrency_method: eager

  # Temporarily disabled - see https://github.com/tensorzero/tensorzero/issues/5887
  # - label: "Clickhouse Cloud tests - fast release channel"
  #   plugins:
  #     - peakon/git-shallow-clone#006b6c0e9e5c73a95c8ac62a60f10cb9ca3c455f:
  #         depth: 1
  #   concurrency: 1
  #   concurrency_group: "clickhouse-cloud-fast-${CLICKHOUSE_ID}"
  #   command: CLICKHOUSE_PREFIX="dev-tensorzero-e2e-tests-fast-instance-" TENSORZERO_CLICKHOUSE_FAST_CHANNEL=1 ./ci/buildkite/test-clickhouse-cloud.sh

notify:
  - github_commit_status:
      # We need a custom status (without a slash in the name) so that we can report
      # it as a dummy status in 'dummy.yml' for PRs
      context: "merge-checks-buildkite"
