name: Trigger Autopilot E2E from slash command

on:
  workflow_dispatch:
  repository_dispatch:
    types: [autopilot-e2e-command]

permissions:
  pull-requests: write
  contents: read
  id-token: write

jobs:
  check-containers:
    runs-on: ubuntu-latest
    if: github.repository == 'tensorzero/tensorzero'
    outputs:
      pr_sha: ${{ steps.get-sha.outputs.pr_sha }}
      need_gateway_e2e: ${{ steps.check.outputs.need_gateway_e2e }}
      need_provider_proxy: ${{ steps.check.outputs.need_provider_proxy }}
      need_ui_dev: ${{ steps.check.outputs.need_ui_dev }}
    steps:
      - name: Add initial reaction
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: eyes

      - name: Get PR SHA
        id: get-sha
        run: echo "pr_sha=${{ github.event.client_payload.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"

      - name: Check if containers exist on DockerHub
        id: check
        run: |
          check_image() {
            local image=$1
            local tag=$2
            local TOKEN
            TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${image}:pull" | jq -r '.token')
            local STATUS
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.docker.distribution.manifest.v2+json,application/vnd.oci.image.manifest.v1+json,application/vnd.docker.distribution.manifest.list.v2+json" \
              "https://registry-1.docker.io/v2/${image}/manifests/${tag}")
            if [ "$STATUS" = "200" ]; then
              echo "found"
            else
              echo "missing"
            fi
          }

          SHA="${{ github.event.client_payload.pull_request.head.sha }}"
          TAG="sha-${SHA}"

          GATEWAY=$(check_image "tensorzero/gateway-e2e" "$TAG")
          PROXY=$(check_image "tensorzero/provider-proxy" "$TAG")
          UI_DEV=$(check_image "tensorzero/ui-dev" "$TAG")

          echo "gateway-e2e: $GATEWAY"
          echo "provider-proxy: $PROXY"
          echo "ui-dev: $UI_DEV"

          echo "need_gateway_e2e=$( [ "$GATEWAY" = "missing" ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "need_provider_proxy=$( [ "$PROXY" = "missing" ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "need_ui_dev=$( [ "$UI_DEV" = "missing" ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

  build-gateway-e2e:
    needs: [check-containers]
    if: needs.check-containers.outputs.need_gateway_e2e == 'true'
    uses: ./.github/workflows/build-gateway-e2e-container.yml
    with:
      ref: ${{ needs.check-containers.outputs.pr_sha }}
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  build-provider-proxy:
    needs: [check-containers]
    if: needs.check-containers.outputs.need_provider_proxy == 'true'
    uses: ./.github/workflows/build-provider-proxy-container.yml
    with:
      ref: ${{ needs.check-containers.outputs.pr_sha }}
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  build-ui-dev:
    needs: [check-containers]
    if: needs.check-containers.outputs.need_ui_dev == 'true'
    uses: ./.github/workflows/build-ui-dev-container.yml
    with:
      ref: ${{ needs.check-containers.outputs.pr_sha }}
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  trigger-autopilot-e2e:
    needs:
      [check-containers, build-gateway-e2e, build-provider-proxy, build-ui-dev]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.AUTOPILOT_DISPATCH_APP_ID }}
          private-key: ${{ secrets.AUTOPILOT_DISPATCH_PRIVATE_KEY }}
          owner: tensorzero
          repositories: autopilot

      - name: Dispatch to autopilot
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: tensorzero/autopilot
          event-type: tensorzero-main-updated
          client-payload: |
            {
              "tensorzero_commit": "${{ needs.check-containers.outputs.pr_sha }}",
              "triggered_by": "${{ github.actor }}",
              "source_run_id": "${{ github.run_id }}",
              "source_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }

      - name: Wait for autopilot workflow and report status
        id: wait-for-autopilot
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          SOURCE_RUN_ID: ${{ github.run_id }}
        run: |
          EXPECTED_NAME="Cross-Repo E2E (tensorzero/$SOURCE_RUN_ID)"
          echo "Looking for workflow run with name: $EXPECTED_NAME"

          sleep 10

          # Find the workflow run by display_title (correlates to our specific dispatch)
          for i in {1..120}; do
            RUN_ID=$(gh api repos/tensorzero/autopilot/actions/runs \
              -q ".workflow_runs[] | select(.display_title==\"$EXPECTED_NAME\") | .id")

            if [ -n "$RUN_ID" ]; then
              break
            fi
            sleep 5
          done

          if [ -z "$RUN_ID" ]; then
            echo "Failed to find autopilot workflow run with name: $EXPECTED_NAME"
            echo "run_url=https://github.com/tensorzero/autopilot/actions" >> $GITHUB_OUTPUT
            exit 1
          fi

          RUN_URL="https://github.com/tensorzero/autopilot/actions/runs/$RUN_ID"
          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT
          echo "Autopilot workflow: $RUN_URL"

          # Poll until complete
          while true; do
            RESULT=$(gh api "repos/tensorzero/autopilot/actions/runs/$RUN_ID" -q '{status: .status, conclusion: .conclusion}')
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "Autopilot E2E tests passed"
                exit 0
              else
                echo "Autopilot E2E tests failed with conclusion: $CONCLUSION"
                exit 1
              fi
            fi

            sleep 30
          done

      - name: Comment with workflow link
        if: always()
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.pull_request.number }}
          body: |
            ðŸš€ Autopilot E2E tests triggered!

            View the run: ${{ steps.wait-for-autopilot.outputs.run_url }}

      - name: Add success reaction
        if: success()
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: hooray

      - name: Add failure reaction
        if: failure()
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: -1
