name: UI Tests

on:
  workflow_call:
    inputs:
      is_merge_group:
        required: true
        type: boolean
  push:
    branches:
      - aaron/clickhouse-lts-debug

permissions:
  contents: read
  actions: read

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    if: github.repository == 'tensorzero/tensorzero'

    strategy:
      matrix:
        clickhouse_version: ${{ (inputs.is_merge_group || github.event_name == 'push') && fromJSON('["lts", "latest"]') || fromJSON('["lts"]') }}

    steps:
      - name: Set DNS
        run: echo "127.0.0.1 howdy.tensorzero.com" | sudo tee -a /etc/hosts

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Cleanup disk space
        run: ./ci/free-disk-space.sh

      - name: Install Rust toolchain
        run: |
          for attempt in 1 2 3; do
            if rustup toolchain install stable && rustup default stable; then
              break
            fi
            if [ $attempt -eq 3 ]; then
              echo "Failed to install Rust toolchain after 3 attempts"
              exit 1
            fi
            sleep $((10 * attempt))
          done
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "24.11.0"

      - name: Setup `pnpm`
        run: |
          for attempt in 1 2 3; do
            if npm install -g pnpm@latest; then
              break
            fi
            if [ $attempt -eq 3 ]; then
              echo "Failed to install pnpm after 3 attempts"
              exit 1
            fi
            sleep $((10 * attempt))
          done
        shell: bash

      - name: Install `pnpm` dependencies
        run: pnpm install --frozen-lockfile

      - name: Build `tensorzero-node`
        working-directory: internal/tensorzero-node
        run: pnpm build:debug

      - name: Download container images
        if: github.event_name != 'push'
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          pattern: build-{gateway,mock-inference}-container
          merge-multiple: true

      - name: Load container images
        if: github.event_name != 'push'
        run: |
          docker load < gateway-container.tar
          docker load < mock-inference-container.tar

      - name: Pull latest published images (debug mode)
        if: github.event_name == 'push'
        run: |
          echo "Pulling latest published images for debugging..."
          docker pull tensorzero/gateway:latest
          docker tag tensorzero/gateway:latest tensorzero/gateway:sha-${{ github.sha }}
          docker pull tensorzero/mock-inference-provider:latest
          docker tag tensorzero/mock-inference-provider:latest tensorzero/mock-inference-provider:sha-${{ github.sha }}

      - name: Start Docker containers and apply fixtures
        working-directory: ui
        run: |
          echo "FIREWORKS_ACCOUNT_ID=not_used" >> fixtures/.env
          echo "TENSORZERO_CLICKHOUSE_URL=http://chuser:chpassword@localhost:8123/tensorzero_ui_fixtures" >> fixtures/.env
          echo "TENSORZERO_GATEWAY_TAG=sha-${{ github.sha }}" >> fixtures/.env
          echo "TENSORZERO_UI_TAG=sha-${{ github.sha }}" >> fixtures/.env
          echo "TENSORZERO_MOCK_INFERENCE_PROVIDER_TAG=sha-${{ github.sha }}" >> fixtures/.env

          # Environment variables only used by the gateway container
          # We deliberately leave these unset when starting the UI container, to ensure
          # that it doesn't depend on them being set
          echo "FIREWORKS_API_KEY=not_used" >> fixtures/.env-gateway
          echo "OPENAI_API_KEY=not_used" >> fixtures/.env-gateway

          echo "=== Starting ClickHouse ${{ matrix.clickhouse_version }} ==="

          # Check what ClickHouse image version we're actually using
          echo "=== Pulling ClickHouse image ==="
          docker pull clickhouse/clickhouse-server:${{ matrix.clickhouse_version }} || echo "Failed to pull specific image"
          docker images | grep clickhouse || echo "No clickhouse images found"

          # Get the actual version
          echo "=== ClickHouse version info ==="
          docker run --rm clickhouse/clickhouse-server:${{ matrix.clickhouse_version }} clickhouse-server --version || echo "Failed to get version"

          TENSORZERO_CLICKHOUSE_VERSION=${{ matrix.clickhouse_version }} docker compose -f fixtures/docker-compose.yml up clickhouse fixtures mock-inference-provider -d

          echo "=== Waiting for fixtures to complete (with timeout monitoring) ==="
          # Monitor fixture loading with timeout
          timeout=600  # 10 minutes
          elapsed=0
          while ! docker compose -f fixtures/docker-compose.yml ps fixtures | grep -q "exited (0)"; do
            if [ $elapsed -ge $timeout ]; then
              echo "ERROR: Fixture loading timed out after $timeout seconds"
              echo "=== Current fixture container status ==="
              docker compose -f fixtures/docker-compose.yml ps fixtures
              echo "=== Fixture container logs ==="
              docker compose -f fixtures/docker-compose.yml logs fixtures
              exit 1
            fi
            if [ $((elapsed % 30)) -eq 0 ]; then
              echo "Still waiting for fixtures... ($elapsed seconds elapsed)"
              docker compose -f fixtures/docker-compose.yml ps fixtures
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done
          echo "Fixtures loaded successfully in $elapsed seconds"

      - name: Debug ClickHouse connection
        working-directory: ui
        run: |
          echo "=== ClickHouse version: ${{ matrix.clickhouse_version }} ==="
          echo "=== Docker container status ==="
          docker compose -f fixtures/docker-compose.yml ps

          echo "=== ClickHouse logs (last 50 lines) ==="
          docker compose -f fixtures/docker-compose.yml logs clickhouse --tail 50

          echo "=== Testing direct ClickHouse connection ==="
          for i in {1..5}; do
            echo "Attempt $i to connect to ClickHouse..."
            if curl -s "http://chuser:chpassword@localhost:8123/ping"; then
              echo "ClickHouse is responding!"
              break
            else
              echo "ClickHouse not responding yet, waiting..."
              sleep 2
            fi
          done

          echo "=== Testing ClickHouse query ==="
          curl -s "http://chuser:chpassword@localhost:8123/?query=SELECT%20version()"
          echo ""

          echo "=== Checking for existing data in database ==="
          curl -s "http://chuser:chpassword@localhost:8123/?query=SELECT%20count()%20FROM%20tensorzero_ui_fixtures.Inference" || echo "Query failed"
          echo ""

      - name: Run `pnpm test`
        env:
          OPENAI_API_KEY: not_used
          FIREWORKS_API_KEY: not_used
          TENSORZERO_UI_CONFIG_PATH: fixtures/config/tensorzero.toml
          TENSORZERO_CLICKHOUSE_URL: http://chuser:chpassword@localhost:8123/tensorzero_ui_fixtures
          TENSORZERO_POSTGRES_URL: postgres://postgres:postgres@localhost:5432/tensorzero_ui_fixtures
          TENSORZERO_GATEWAY_URL: http://localhost:3000
        run: |
          echo "=== Running UI tests with ClickHouse ${{ matrix.clickhouse_version }} ==="
          echo "TENSORZERO_CLICKHOUSE_URL: $TENSORZERO_CLICKHOUSE_URL"
          pnpm ui:test --reporter=verbose

      - name: Debug ClickHouse state after test
        if: failure()
        working-directory: ui
        run: |
          echo "=== ClickHouse is still running? ==="
          docker compose -f fixtures/docker-compose.yml ps clickhouse

          echo "=== ClickHouse process list ==="
          curl -s "http://chuser:chpassword@localhost:8123/?query=SHOW%20PROCESSLIST%20FORMAT%20JSON" | jq . || echo "Failed to get process list"

          echo "=== ClickHouse system.query_log (recent queries) ==="
          curl -s "http://chuser:chpassword@localhost:8123/?query=SELECT%20query_start_time%2C%20query_duration_ms%2C%20query%20FROM%20system.query_log%20WHERE%20query_start_time%20%3E%20now()%20-%20INTERVAL%205%20MINUTE%20ORDER%20BY%20query_start_time%20DESC%20LIMIT%2050%20FORMAT%20JSONEachRow" | jq -s . || echo "Failed to get query log"

          echo "=== ClickHouse error logs (last 100 lines) ==="
          docker compose -f fixtures/docker-compose.yml logs clickhouse --tail 100

      - name: Run `pnpm test` for tensorzero-node
        working-directory: internal/tensorzero-node
        env:
          TENSORZERO_POSTGRES_URL: postgres://postgres:postgres@localhost:5432/tensorzero_ui_fixtures
        run: pnpm test

      - name: Print Docker Compose logs
        if: always()
        working-directory: ui
        run: docker compose -f fixtures/docker-compose.yml logs -t

      - name: Print Docker Compose status
        if: always()
        working-directory: ui
        run: docker compose -f fixtures/docker-compose.yml ps --all

      - name: Make sure the current commit short hash is in the Docker Compose gateway logs
        if: always()
        working-directory: ui
        run: |
          SHORT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)
          docker compose -f fixtures/docker-compose.yml logs gateway | grep "(commit: ${SHORT_HASH})" || {
            echo "ERROR: Commit hash ${SHORT_HASH} not found in gateway logs"
            exit 1
          }

      - name: Print ClickHouse error logs
        if: always()
        working-directory: ui
        run: docker cp fixtures-clickhouse-1:/var/log/clickhouse-server/clickhouse-server.err.log -

      - name: Print ClickHouse trace logs
        if: always()
        working-directory: ui
        run: docker cp fixtures-clickhouse-1:/var/log/clickhouse-server/clickhouse-server.log -
