name: Live Tests

on:
  workflow_call:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Runs at 00:00 UTC every day

env:
  CARGO_INCREMENTAL: 0
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
  AWS_REGION: "us-east-1"
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AZURE_API_KEY: ${{ secrets.AZURE_API_KEY_NEW }}
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  FIREWORKS_ACCOUNT_ID: ${{ secrets.FIREWORKS_ACCOUNT_ID }}
  FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
  FORCE_COLOR: 1
  GCP_STORAGE_ACCESS_KEY_ID: ${{ secrets.GCP_STORAGE_ACCESS_KEY_ID }}
  GCP_STORAGE_SECRET_ACCESS_KEY: ${{ secrets.GCP_STORAGE_SECRET_ACCESS_KEY }}
  GCP_VERTEX_CREDENTIALS_PATH: ${{ github.workspace }}/gcp_jwt_key.json
  GOOGLE_AI_STUDIO_API_KEY: ${{ secrets.GOOGLE_AI_STUDIO_API_KEY }}
  GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp_jwt_key.json
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  HYPERBOLIC_API_KEY: ${{secrets.HYPERBOLIC_API_KEY}}
  MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
  MODAL_KEY: ${{ secrets.MODAL_KEY }}
  MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  SGLANG_API_KEY: ${{ secrets.SGLANG_API_KEY }}
  TGI_API_KEY: ${{ secrets.TGI_API_KEY }}
  TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
  VLLM_API_BASE: ${{ secrets.VLLM_API_BASE }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  VLLM_MODEL_NAME: "microsoft/Phi-3.5-mini-instruct"
  VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
  OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: https://localhost:4316
  SQLX_OFFLINE: 1
  TENSORZERO_E2E_PROXY: http://localhost:3003
  TENSORZERO_COMMIT_TAG: sha-${{ github.sha }}
  TENSORZERO_GATEWAY_TAG: sha-${{ github.sha }}
  TENSORZERO_MOCK_PROVIDER_API_TAG: sha-${{ github.sha }}
  TENSORZERO_CI: 1
  CARGO_NEXTEST_FLAKY_TESTS: ${{ vars.CARGO_NEXTEST_FLAKY_TESTS }}

jobs:
  # Build containers for standalone runs (schedule/workflow_dispatch).
  # When called from general.yml via workflow_call, these are skipped
  # because the caller already built and uploaded the container artifacts.
  build-gateway-e2e-container:
    if: github.repository == 'tensorzero/tensorzero' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    uses: ./.github/workflows/build-gateway-e2e-container.yml
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  build-gateway-container:
    if: github.repository == 'tensorzero/tensorzero' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    uses: ./.github/workflows/build-gateway-container.yml
    permissions:
      contents: read
      id-token: write

  build-fixtures-container:
    if: github.repository == 'tensorzero/tensorzero' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    uses: ./.github/workflows/build-fixtures-container.yml
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  build-provider-proxy-container:
    if: github.repository == 'tensorzero/tensorzero' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    uses: ./.github/workflows/build-provider-proxy-container.yml
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  build-live-tests-container:
    if: github.repository == 'tensorzero/tensorzero' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    uses: ./.github/workflows/build-live-tests-container.yml
    permissions:
      contents: read
      id-token: write
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_LIMITED_TOKEN: ${{ secrets.DOCKERHUB_LIMITED_TOKEN }}

  live-tests:
    needs:
      [
        build-gateway-e2e-container,
        build-gateway-container,
        build-fixtures-container,
        build-provider-proxy-container,
        build-live-tests-container,
      ]
    # Run even when build jobs are skipped (workflow_call case where caller already built them)
    if: always() && !failure() && !cancelled() && github.repository == 'tensorzero/tensorzero'
    name: "live-tests (batch_writes: ${{ matrix.batch_writes }})"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    timeout-minutes: 45
    strategy:
      matrix:
        batch_writes: [true, false]
      # Don't fail-fast for manual/cron runs, so that we get the full picture of what broke
      fail-fast: ${{ github.event_name == 'merge_group' }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Cleanup disk space
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be

      - name: Download gateway container image
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: build-gateway-container

      - name: Download provider-proxy container image
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: build-provider-proxy-container

      - name: Download gateway-e2e container image
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: build-gateway-e2e-container

      - name: Download live-tests container image
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: build-live-tests-container

      - name: Download fixtures container image
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: build-fixtures-container

      - name: Load container images
        run: |
          docker load < gateway-container.tar
          docker load < provider-proxy-container.tar
          docker load < gateway-e2e-container.tar
          docker load < live-tests-container.tar
          docker load < fixtures-container.tar
          docker tag tensorzero/fixtures:sha-${{ github.sha }} tensorzero/fixtures-postgres:sha-${{ github.sha }}

      - name: Restore provider-proxy cache
        if: github.event_name != 'schedule'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: ./ci/provider-proxy-cache/
          key: provider-proxy-cache-${{ github.run_id }}
          restore-keys: provider-proxy-cache-

      - name: Download provider-proxy cache
        # When running as a cron job, don't use the provider-proxy cache.
        # The cron job is used to gather information about provider flakiness.
        if: github.event_name != 'schedule'
        run: |
          AWS_ACCESS_KEY_ID=$R2_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$R2_SECRET_ACCESS_KEY PROVIDER_PROXY_CACHE_BUCKET=provider-proxy-cache ./ci/download-provider-proxy-cache.sh

      - name: Login to DockerHub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Write GCP JWT key to file
        env:
          GCP_JWT_KEY: ${{ secrets.GCP_JWT_KEY }}
        run: echo "$GCP_JWT_KEY" > $GITHUB_WORKSPACE/gcp_jwt_key.json

      - name: Pull images referenced by the compose file
        run: docker compose -f tensorzero-core/tests/e2e/docker-compose.live.yml --profile provider-proxy pull --ignore-pull-failures

      - name: Run live tests container via Docker Compose
        run: |
          DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) docker compose -f tensorzero-core/tests/e2e/docker-compose.live.yml --profile provider-proxy run --rm -e TENSORZERO_CI=1 -e TENSORZERO_FF_WRITE_CONFIG_SNAPSHOT=1 live-tests

      - name: Print live tests logs
        if: always()
        run: docker compose -f tensorzero-core/tests/e2e/docker-compose.live.yml --profile provider-proxy logs -t

      - name: Check e2e logs for impossible error messages
        run: |
          LOGS=$(docker compose -f tensorzero-core/tests/e2e/docker-compose.live.yml --profile provider-proxy logs gateway)
          if [ -z "$LOGS" ]; then
            echo "ERROR: Gateway logs are empty"
            exit 1
          fi
          grep --invert-match -i "please file a bug report" <<< "$LOGS"

      # TODO - re-enable this: https://github.com/tensorzero/tensorzero/issues/3989
      # - name: Check e2e logs for deprecation warnings (gateway e2e tests only)
      #   run: |
      #     LOGS=$(docker compose -f tensorzero-core/tests/e2e/docker-compose.live.yml logs gateway)
      #     if [ -z "$LOGS" ]; then
      #       echo "ERROR: Gateway logs are empty"
      #       exit 1
      #     fi
      #     ! grep -i "Deprecation Warning" "$LOGS"

      - name: Upload provider-proxy cache
        # Only upload the cache from trusted runs (merge queue or cron)
        if: github.event_name == 'merge_group' || github.event_name == 'schedule'
        run: |
          AWS_ACCESS_KEY_ID=$R2_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$R2_SECRET_ACCESS_KEY PROVIDER_PROXY_CACHE_BUCKET=provider-proxy-cache ./ci/upload-provider-proxy-cache.sh

  # Post to Slack on failure for scheduled (cron) runs only.
  # Scheduled runs bypass the provider-proxy cache to detect provider flakiness.
  # See: https://github.com/tensorzero/tensorzero/issues/5380
  notify-on-failure:
    permissions: {}
    if: always() && github.event_name == 'schedule' && needs.live-tests.result == 'failure'
    needs: [live-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Post to Slack on failure
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: C09DM0RGDFG
            text: "Live tests failed (scheduled run, no cache): <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
