---
title: Deploy ClickHouse (optional)
description: Learn how to deploy ClickHouse for TensorZero's observability features.
---

The TensorZero Gateway can optionally collect inference and feedback data for observability, optimization, evaluation, and experimentation.
Under the hood, TensorZero stores this data in ClickHouse, an open-source columnar database that is optimized for analytical workloads.

<Tip>
  If you're planning to use the gateway without observability, you don't need to
  deploy ClickHouse.
</Tip>

## Deploy

### Development

For development purposes, you can run a single-node ClickHouse instance locally (e.g. using Homebrew or Docker) or a cheap Development-tier cluster on ClickHouse Cloud.

See the [ClickHouse documentation](https://clickhouse.com/docs/install) for more details on configuring your ClickHouse deployment.

### Production

#### Managed deployments

For production deployments, the easiest setup is to use a managed service like <a href="https://clickhouse.com/cloud" target="_blank">ClickHouse Cloud</a>.

ClickHouse Cloud is also available through the [AWS Marketplace](https://aws.amazon.com/marketplace/pp/prodview-jettukeanwrfc), [GCP Marketplace](https://console.cloud.google.com/marketplace/product/clickhouse-public/clickhouse-cloud), and [Azure Marketplace](https://azuremarketplace.microsoft.com/en-us/marketplace/apps/clickhouse.clickhouse_cloud).

Other options for managed ClickHouse deployments include [Tinybird](https://www.tinybird.co/) (serverless) and [Altinity](https://www.altinity.com/) (hands-on support).

<Note>
  TensorZero tests against ClickHouse Cloud's `regular` and `fast` release
  channels.
</Note>

#### Self-hosted deployments

You can alternatively run your own self-managed ClickHouse instance or cluster.

TensorZero supports single-node, replicated, and sharded deployments.

See the [ClickHouse documentation](https://clickhouse.com/docs/install) for more details on configuring your ClickHouse deployment.

<Note>
  TensorZero tests against ClickHouse `24.12` and `latest`. We recommend pinning
  a version (`24.12` or newer). ClickHouse will occasionally introduce breaking
  changes and other issues (e.g. `25.8` had multiple regressions).
</Note>

## Configure

### Connecting to ClickHouse

To configure TensorZero to use ClickHouse, set the `TENSORZERO_CLICKHOUSE_URL` environment variable with your ClickHouse connection details.

```bash title=".env"
TENSORZERO_CLICKHOUSE_URL="http[s]://[username]:[password]@[hostname]:[port]/[database]"

# Example: ClickHouse running locally
TENSORZERO_CLICKHOUSE_URL="http://chuser:chpassword@localhost:8123/tensorzero"

# Example: ClickHouse Cloud
TENSORZERO_CLICKHOUSE_URL="https://USERNAME:PASSWORD@XXXXX.clickhouse.cloud:8443/tensorzero"

# Example: TensorZero Gateway running in a container, ClickHouse running on host machine
TENSORZERO_CLICKHOUSE_URL="http://host.docker.internal:8123/tensorzero"
```

If you're using a self-hosted replicated ClickHouse deployment, you must also provide the ClickHouse cluster name in the `TENSORZERO_CLICKHOUSE_CLUSTER_NAME` environment variable.

### Sharded deployments

TensorZero supports sharded ClickHouse deployments for horizontal scaling. To enable sharding, you must:

1. **Set up a ClickHouse cluster**: Configure a multi-shard ClickHouse cluster with the appropriate distributed and local tables
2. **Enable sharding in TensorZero**: Set the required environment variables

```bash title=".env"
# Required for sharded deployments
TENSORZERO_CLICKHOUSE_CLUSTER_NAME="your_cluster_name"
TENSORZERO_CLICKHOUSE_SHARDING_ENABLED="true"

# Optional: customize the sharding key (defaults to "rand()")
TENSORZERO_CLICKHOUSE_SHARDING_KEY="rand()"
```

#### Sharding configuration options

- **`TENSORZERO_CLICKHOUSE_SHARDING_ENABLED`**: Set to `"true"` to enable sharding support (default: `"false"`)
- **`TENSORZERO_CLICKHOUSE_SHARDING_KEY`**: The sharding key expression for data distribution (default: `"rand()"`)

Common sharding key options:
- `"rand()"` - Random distribution across shards (recommended for most use cases)
- `"cityHash64(column_name)"` - Hash-based distribution on a specific column for data locality
- Custom expressions based on your specific data distribution requirements

#### How sharding works in TensorZero

When sharding is enabled, TensorZero automatically:
- Creates distributed tables for querying data across all shards
- Creates local tables on each shard for actual data storage
- Routes indices to local tables only (where they're effective)
- Configures materialized views to read from local tables and write to distributed tables
- Handles all migration operations transparently across the cluster

This design ensures optimal performance while maintaining data consistency across your sharded ClickHouse deployment.

### Applying database migrations

The TensorZero Gateway typically applies database migrations automatically when it starts up.

If you're using a self-hosted replicated or sharded ClickHouse deployment, you must apply database migrations manually with `gateway --run-migrations-only`.
In this case, the gateway will not apply migrations automatically, and will error on startup if migrations are missing.

<Note>
  For sharded deployments, ensure that `TENSORZERO_CLICKHOUSE_SHARDING_ENABLED="true"` is set when running migrations to ensure proper distributed and local table creation.
</Note>
